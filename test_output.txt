============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.4.2, pluggy-1.6.0 -- /home/moreli/projetos/brumas2/venv/bin/python3
cachedir: .pytest_cache
rootdir: /home/moreli/projetos/brumas2
configfile: pytest.ini
testpaths: tests
plugins: cov-7.0.0, asyncio-1.2.0, anyio-4.11.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 27 items

tests/test_auth.py::test_login_success PASSED                            [  3%]
tests/test_auth.py::test_login_invalid_username PASSED                   [  7%]
tests/test_auth.py::test_login_invalid_password PASSED                   [ 11%]
tests/test_auth.py::test_access_protected_endpoint_without_token PASSED  [ 14%]
tests/test_auth.py::test_access_protected_endpoint_with_invalid_token PASSED [ 18%]
tests/test_dimensions.py::test_create_cliente PASSED                     [ 22%]
tests/test_dimensions.py::test_list_clientes PASSED                      [ 25%]
tests/test_dimensions.py::test_update_cliente FAILED                     [ 29%]
tests/test_dimensions.py::test_delete_cliente FAILED                     [ 33%]
tests/test_eventos.py::test_create_evento_success PASSED                 [ 37%]
tests/test_eventos.py::test_create_evento_invalid_cliente PASSED         [ 40%]
tests/test_eventos.py::test_get_evento_by_id PASSED                      [ 44%]
tests/test_eventos.py::test_get_evento_not_found PASSED                  [ 48%]
tests/test_eventos.py::test_list_eventos_with_pagination PASSED          [ 51%]
tests/test_eventos.py::test_list_eventos_with_filters PASSED             [ 55%]
tests/test_eventos.py::test_update_evento_success PASSED                 [ 59%]
tests/test_eventos.py::test_update_evento_permission_denied PASSED       [ 62%]
tests/test_eventos.py::test_delete_evento_success PASSED                 [ 66%]
tests/test_eventos.py::test_add_despesa_to_evento PASSED                 [ 70%]
tests/test_eventos.py::test_add_degustacao_to_evento PASSED              [ 74%]
tests/test_users.py::test_create_user_as_admin PASSED                    [ 77%]
tests/test_users.py::test_create_user_as_operational_forbidden PASSED    [ 81%]
tests/test_users.py::test_list_users_as_admin PASSED                     [ 85%]
tests/test_users.py::test_get_user_by_id PASSED                          [ 88%]
tests/test_users.py::test_update_user PASSED                             [ 92%]
tests/test_users.py::test_delete_user PASSED                             [ 96%]
tests/test_users.py::test_admin_cannot_delete_self PASSED                [100%]

=================================== FAILURES ===================================
_____________________________ test_update_cliente ______________________________
tests/test_dimensions.py:52: in test_update_cliente
    assert response.status_code == 200
E   assert 403 == 200
E    +  where 403 = <Response [403 Forbidden]>.status_code
---------------------------- Captured stdout setup -----------------------------
{"timestamp": "2025-10-30T00:31:51.246983+00:00", "level": "INFO", "name": "root", "message": "\ud83d\ude80 Aplica\u00e7\u00e3o iniciada: Brumas API", "environment": "development", "api_version": "/api/v1", "app": "Brumas API", "logger_name": "root"}
{"timestamp": "2025-10-30T00:31:51.295313+00:00", "level": "INFO", "name": "root", "message": "Request started: POST http://testserver/login/access-token", "request_id": "211f78d9-58a1-421c-a7da-807697dbe994", "method": "POST", "url": "http://testserver/login/access-token", "ip_address": "testclient", "user_agent": "testclient", "app": "Brumas API", "environment": "development", "logger_name": "root"}
{"timestamp": "2025-10-30T00:31:51.345602+00:00", "level": "INFO", "name": "root", "message": "Request completed: POST http://testserver/login/access-token - Status: 200", "request_id": "211f78d9-58a1-421c-a7da-807697dbe994", "method": "POST", "url": "http://testserver/login/access-token", "status_code": 200, "process_time": 0.05, "ip_address": "testclient", "app": "Brumas API", "environment": "development", "logger_name": "root"}
{"timestamp": "2025-10-30T00:31:51.346503+00:00", "level": "INFO", "name": "httpx", "message": "HTTP Request: POST http://testserver/login/access-token \"HTTP/1.1 200 OK\"", "app": "Brumas API", "environment": "development", "logger_name": "httpx"}
------------------------------ Captured log setup ------------------------------
INFO     root:main.py:44 ðŸš€ AplicaÃ§Ã£o iniciada: Brumas API
INFO     root:logging.py:34 Request started: POST http://testserver/login/access-token
INFO     root:logging.py:56 Request completed: POST http://testserver/login/access-token - Status: 200
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/login/access-token "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
{"timestamp": "2025-10-30T00:31:51.405806+00:00", "level": "INFO", "name": "root", "message": "Request started: PATCH http://testserver/api/v1/dimensions/clientes/1", "request_id": "414d47f5-1e4d-4f73-b440-7955836d2f62", "method": "PATCH", "url": "http://testserver/api/v1/dimensions/clientes/1", "ip_address": "testclient", "user_agent": "testclient", "app": "Brumas API", "environment": "development", "logger_name": "root"}
{"timestamp": "2025-10-30T00:31:51.409904+00:00", "level": "INFO", "name": "root", "message": "Request completed: PATCH http://testserver/api/v1/dimensions/clientes/1 - Status: 403", "request_id": "414d47f5-1e4d-4f73-b440-7955836d2f62", "method": "PATCH", "url": "http://testserver/api/v1/dimensions/clientes/1", "status_code": 403, "process_time": 0.004, "ip_address": "testclient", "app": "Brumas API", "environment": "development", "logger_name": "root"}
{"timestamp": "2025-10-30T00:31:51.410687+00:00", "level": "INFO", "name": "httpx", "message": "HTTP Request: PATCH http://testserver/api/v1/dimensions/clientes/1 \"HTTP/1.1 403 Forbidden\"", "app": "Brumas API", "environment": "development", "logger_name": "httpx"}
------------------------------ Captured log call -------------------------------
INFO     root:logging.py:34 Request started: PATCH http://testserver/api/v1/dimensions/clientes/1
INFO     root:logging.py:56 Request completed: PATCH http://testserver/api/v1/dimensions/clientes/1 - Status: 403
INFO     httpx:_client.py:1025 HTTP Request: PATCH http://testserver/api/v1/dimensions/clientes/1 "HTTP/1.1 403 Forbidden"
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": "2025-10-30T00:31:51.435309+00:00", "level": "INFO", "name": "root", "message": "\ud83d\uded1 Aplica\u00e7\u00e3o encerrada: Brumas API", "environment": "development", "app": "Brumas API", "logger_name": "root"}
---------------------------- Captured log teardown -----------------------------
INFO     root:main.py:56 ðŸ›‘ AplicaÃ§Ã£o encerrada: Brumas API
_____________________________ test_delete_cliente ______________________________
tests/test_dimensions.py:65: in test_delete_cliente
    assert response.status_code == 200
E   assert 403 == 200
E    +  where 403 = <Response [403 Forbidden]>.status_code
---------------------------- Captured stdout setup -----------------------------
{"timestamp": "2025-10-30T00:31:51.449362+00:00", "level": "INFO", "name": "root", "message": "\ud83d\ude80 Aplica\u00e7\u00e3o iniciada: Brumas API", "environment": "development", "api_version": "/api/v1", "app": "Brumas API", "logger_name": "root"}
{"timestamp": "2025-10-30T00:31:51.496848+00:00", "level": "INFO", "name": "root", "message": "Request started: POST http://testserver/login/access-token", "request_id": "3c437d67-7797-4986-a1ec-fa17cbba0aa6", "method": "POST", "url": "http://testserver/login/access-token", "ip_address": "testclient", "user_agent": "testclient", "app": "Brumas API", "environment": "development", "logger_name": "root"}
{"timestamp": "2025-10-30T00:31:51.549221+00:00", "level": "INFO", "name": "root", "message": "Request completed: POST http://testserver/login/access-token - Status: 200", "request_id": "3c437d67-7797-4986-a1ec-fa17cbba0aa6", "method": "POST", "url": "http://testserver/login/access-token", "status_code": 200, "process_time": 0.052, "ip_address": "testclient", "app": "Brumas API", "environment": "development", "logger_name": "root"}
{"timestamp": "2025-10-30T00:31:51.550077+00:00", "level": "INFO", "name": "httpx", "message": "HTTP Request: POST http://testserver/login/access-token \"HTTP/1.1 200 OK\"", "app": "Brumas API", "environment": "development", "logger_name": "httpx"}
------------------------------ Captured log setup ------------------------------
INFO     root:main.py:44 ðŸš€ AplicaÃ§Ã£o iniciada: Brumas API
INFO     root:logging.py:34 Request started: POST http://testserver/login/access-token
INFO     root:logging.py:56 Request completed: POST http://testserver/login/access-token - Status: 200
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/login/access-token "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
{"timestamp": "2025-10-30T00:31:51.599720+00:00", "level": "INFO", "name": "root", "message": "Request started: DELETE http://testserver/api/v1/dimensions/clientes/1", "request_id": "db2746f0-c215-4b9d-a219-33593d89af1b", "method": "DELETE", "url": "http://testserver/api/v1/dimensions/clientes/1", "ip_address": "testclient", "user_agent": "testclient", "app": "Brumas API", "environment": "development", "logger_name": "root"}
{"timestamp": "2025-10-30T00:31:51.603304+00:00", "level": "INFO", "name": "root", "message": "Request completed: DELETE http://testserver/api/v1/dimensions/clientes/1 - Status: 403", "request_id": "db2746f0-c215-4b9d-a219-33593d89af1b", "method": "DELETE", "url": "http://testserver/api/v1/dimensions/clientes/1", "status_code": 403, "process_time": 0.003, "ip_address": "testclient", "app": "Brumas API", "environment": "development", "logger_name": "root"}
{"timestamp": "2025-10-30T00:31:51.603983+00:00", "level": "INFO", "name": "httpx", "message": "HTTP Request: DELETE http://testserver/api/v1/dimensions/clientes/1 \"HTTP/1.1 403 Forbidden\"", "app": "Brumas API", "environment": "development", "logger_name": "httpx"}
------------------------------ Captured log call -------------------------------
INFO     root:logging.py:34 Request started: DELETE http://testserver/api/v1/dimensions/clientes/1
INFO     root:logging.py:56 Request completed: DELETE http://testserver/api/v1/dimensions/clientes/1 - Status: 403
INFO     httpx:_client.py:1025 HTTP Request: DELETE http://testserver/api/v1/dimensions/clientes/1 "HTTP/1.1 403 Forbidden"
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": "2025-10-30T00:31:51.606923+00:00", "level": "INFO", "name": "root", "message": "\ud83d\uded1 Aplica\u00e7\u00e3o encerrada: Brumas API", "environment": "development", "app": "Brumas API", "logger_name": "root"}
---------------------------- Captured log teardown -----------------------------
INFO     root:main.py:56 ðŸ›‘ AplicaÃ§Ã£o encerrada: Brumas API
=============================== warnings summary ===============================
venv/lib/python3.12/site-packages/starlette/formparsers.py:12
  /home/moreli/projetos/brumas2/venv/lib/python3.12/site-packages/starlette/formparsers.py:12: PendingDeprecationWarning: Please use `import python_multipart` instead.
    import multipart

venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:284
venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:284
venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:284
venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:284
venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:284
  /home/moreli/projetos/brumas2/venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:284: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.7/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

venv/lib/python3.12/site-packages/pythonjsonlogger/jsonlogger.py:11
  /home/moreli/projetos/brumas2/venv/lib/python3.12/site-packages/pythonjsonlogger/jsonlogger.py:11: DeprecationWarning: pythonjsonlogger.jsonlogger has been moved to pythonjsonlogger.json
    warnings.warn(

app/db/base.py:14
  /home/moreli/projetos/brumas2/app/db/base.py:14: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

venv/lib/python3.12/site-packages/passlib/utils/__init__.py:854
  /home/moreli/projetos/brumas2/venv/lib/python3.12/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

app/api/routers/eventos.py:225
  /home/moreli/projetos/brumas2/app/api/routers/eventos.py:225: DeprecationWarning: `regex` has been deprecated, please use `pattern` instead
    order_direction: str = Query(

app/main.py:41
  /home/moreli/projetos/brumas2/app/main.py:41: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

venv/lib/python3.12/site-packages/fastapi/applications.py:4495
venv/lib/python3.12/site-packages/fastapi/applications.py:4495
  /home/moreli/projetos/brumas2/venv/lib/python3.12/site-packages/fastapi/applications.py:4495: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

app/main.py:53
  /home/moreli/projetos/brumas2/app/main.py:53: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("shutdown")

tests/test_auth.py::test_login_success
  /home/moreli/projetos/brumas2/venv/lib/python3.12/site-packages/passlib/handlers/argon2.py:716: DeprecationWarning: Accessing argon2.__version__ is deprecated and will be removed in a future release. Use importlib.metadata directly to query for argon2-cffi's packaging metadata.
    _argon2_cffi.__version__, max_version)

tests/test_dimensions.py: 4 warnings
tests/test_eventos.py: 12 warnings
tests/test_users.py: 8 warnings
  /home/moreli/projetos/brumas2/venv/lib/python3.12/site-packages/jose/jwt.py:311: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = timegm(datetime.utcnow().utctimetuple())

tests/test_dimensions.py::test_create_cliente
  /home/moreli/projetos/brumas2/app/crud/base.py:43: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    setattr(db_obj, "updated_at", datetime.utcnow())

tests/test_dimensions.py::test_create_cliente
  /home/moreli/projetos/brumas2/app/crud/base.py:46: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    setattr(db_obj, "created_at", datetime.utcnow())

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.3-final-0 ________________

Name                            Stmts   Miss  Cover   Missing
-------------------------------------------------------------
app/api/deps.py                    38      7    82%   29-33, 56, 68, 92
app/api/routers/dimensions.py      53     11    79%   61-73, 85, 95, 106, 116
app/api/routers/eventos.py        139     55    60%   115-124, 484-542, 565-623, 702-762, 785-846
app/api/routers/login.py           20      1    95%   44
app/api/routers/users.py           38      3    92%   35, 80, 97
app/core/config.py                 18      1    94%   43
app/core/logging.py                42      3    93%   30, 96, 101
app/core/security.py               17      1    94%   44
app/crud/base.py                   49     18    63%   36-40, 61-72, 75-79
app/crud/crud_dimension.py         24      0   100%
app/crud/crud_event.py            140     46    67%   45, 52-58, 65-71, 78-84, 91-97, 178, 181, 184, 187, 200, 205, 241, 244, 247, 250, 322, 345-366, 375-376, 406-414, 423-424
app/crud/crud_user.py              37      2    95%   56-57
app/db/base.py                      2      0   100%
app/db/session.py                   5      0   100%
app/main.py                        27      3    89%   67-68, 74
app/middleware/logging.py          25      4    84%   73-91
app/models/dimension.py            84      0   100%
app/models/event.py                93      0   100%
app/models/user.py                 29      0   100%
app/schemas/common.py              24      0   100%
app/schemas/dimension.py          112      0   100%
app/schemas/event.py              117      0   100%
app/schemas/token.py                7      0   100%
app/schemas/user.py                20      0   100%
-------------------------------------------------------------
TOTAL                            1160    155    87%
Coverage HTML written to dir htmlcov
=========================== short test summary info ============================
FAILED tests/test_dimensions.py::test_update_cliente - assert 403 == 200
 +  where 403 = <Response [403 Forbidden]>.status_code
FAILED tests/test_dimensions.py::test_delete_cliente - assert 403 == 200
 +  where 403 = <Response [403 Forbidden]>.status_code
================== 2 failed, 25 passed, 41 warnings in 4.25s ===================
